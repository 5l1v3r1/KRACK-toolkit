#include "krack.h"

void interface_list(struct ifaddrs *interfaces[], const size_t size) {
    struct ifaddrs*  ifap = NULL;
    struct ifaddrs*  ifaptr = NULL;

    if (getifaddrs(&ifap) != 0) {
        return;
    }

    int i = 0;
    for(ifaptr = ifap; ifaptr != NULL; ifaptr = (ifaptr)->ifa_next) {
        if (((ifaptr)->ifa_addr)->sa_family == AF_LINK) {
            interfaces[i++] = ifaptr; 
        }

        /**
         * Make sure we don't go out of bounds
         * if an interface appeared after getting
         * a count (unlikely, but might as well be safe.
         */
        if (i == size) break;
    }
}

char* get_interface_mac(const struct ifaddrs* interface) {
    size_t mem_size = 17 * sizeof(char);
    char* mac = malloc(mem_size);
    unsigned char* ptr = (unsigned char *)LLADDR((struct sockaddr_dl *)(interface)->ifa_addr);
    snprintf(mac, mem_size, "%02x:%02x:%02x:%02x:%02x:%02x",
            *ptr, *(ptr + 1), *(ptr + 2), *(ptr + 3), *(ptr + 4), *(ptr + 5));

    return mac;
}

size_t interface_count() {
    struct ifaddrs* ifap = NULL;
    struct ifaddrs* ifaptr = NULL;

    if (getifaddrs(&ifap) != 0) {
        return 0;
    }

    int count = 0;
    for(ifaptr = ifap; ifaptr != NULL; ifaptr = (ifaptr)->ifa_next) {
        if (((ifaptr)->ifa_addr)->sa_family == AF_LINK) {
            count++;
        }
    }

    return count;
}
